#'@importFrom rmisc db_query
#'@importFrom rmisc db_bulk_insert
#'@importFrom rmisc "%has_tables%"
#'@importFrom ncbi taxonDBConnect
#'@importFrom ncbi geneidDBConnect
NULL

taxonomy_create.sql <- 'CREATE TABLE taxonomy(
                        query_id        INTEGER,
                        hit_id          INTEGER,
                        gene_id         TEXT,
                        accession       TEXT,
                        tax_id          TEXT,
                        scientific_name	TEXT,
                        rank            TEXT,
                        PRIMARY KEY (hit_id),
                        FOREIGN KEY (query_id) REFERENCES query (query_id),
                        FOREIGN KEY (hit_id) REFERENCES query (hit_id)
                );
                CREATE INDEX Ftaxonomy_query ON taxonomy (query_id);
                CREATE INDEX Ftaxonomy_hit ON taxonomy (hit_id);
                CREATE INDEX Ftaxonomy_tax ON taxonomy (tax_id);
                CREATE INDEX Ftaxaonomy_tax_hit_query ON hsp (query_id, hit_id, tax_id);
                '

#' Create or connect a local install of NCBI Taxonomy database
#'
#'@description Create, update or connect to a local installation of the NCBI 
#'             Taxonomy Database. The Connection objectis returned as a list 
#'             of connections to \code{'taxon.db'} and \code{'geneid.db'}. 
#'
#'@param path_to_db parent directory for the taxonomy db
#'
#'@rdname taxonDB
#'@export
connectTaxonDB <- function(path_to_db) {
  list(taxon_db = taxonDBConnect(path_to_db), 
       geneid_db = geneidDBConnect(path_to_db))
}

#' @rdname taxonDB
#' @export
createTaxonDB <- function(path_to_db) {
  ncbi::createTaxonDB(path_to_db)
  ncbi::createGeneidDB(path_to_db)
}

#'@rdname taxonDB
#'@export
updateTaxonDB <- function(path_to_db) {
  ncbi::updateTaxonDB(path_to_db)
}

#' create, update or drop a SQL-Table
#' 
#'@description wrapper for database manipulation in SQL
#'
#'@param blast_db connection to a database
#'@param tbl name of table
#'@param sql string with table scheme
#'
#' @rdname db-functions
#' @export 
createTable <- function (db, tbl, tbl_scheme) {
  if (db %has_tables% tbl) {
    # table already exists -> delete and rewrite
    dropTable(db, tbl)
  }
  db_query(db,tbl_scheme)
}

#'@param df data.frame generated by assignTaxon()
#'
#'@rdname db-functions
#'@export
updateTable <- function (db, tbl, df) {
  db_bulk_insert(db, tbl, df)
}

#'@rdname db-functions
#'@export
dropTable <- function (db, tbl) {
  db_query(db, paste("DROP table",tbl))
}

